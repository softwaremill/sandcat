#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/path.bash
source "$SCT_LIBDIR/path.bash"
# shellcheck source=../../lib/select.bash
source "$SCT_LIBDIR/select.bash"
# shellcheck source=../../lib/logging.bash
source "$SCT_LIBDIR/logging.bash"

# Opens the compose file in an editor. Warns if containers need restarting.
edit() {
	local no_restart="${SANDCAT_NO_RESTART:-false}"

	while [[ $# -gt 0 ]]
	do
		case $1 in
		--no-restart)
			no_restart=true
			shift
			;;
		*)
			echo "Unknown option: $1" | error
			return 1
			;;
		esac
	done

	local compose_file
	compose_file="$(find_compose_file)"

	local mtime_before
	mtime_before=$(get_file_mtime "$compose_file")

	open_editor "$compose_file"

	local mtime_after
	mtime_after=$(get_file_mtime "$compose_file")

	if [[ "$mtime_before" != "$mtime_after" ]]
	then
		local running
		running=$("$SCT_LIBEXECDIR/compose/compose" ps --status running --quiet 2>/dev/null) || true

		if [[ -n "$running" ]]
		then
			if [[ "$no_restart" == "true" ]]
			then
				echo "Compose file was modified, and you have containers running." | warning
				echo "To pick up the changes and restart your containers, run: sandcat compose up -d" | warning
			else
				echo "Compose file was modified. Restarting containers..." | info
				"$SCT_LIBEXECDIR/compose/compose" up -d
			fi
		else
			echo "Compose file was modified." | info
		fi
	else
		echo "No changes detected." | info
	fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	edit "$@"
fi
