#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/logging.bash
source "$SCT_LIBDIR/logging.bash"
# shellcheck source=../../lib/require.bash
source "$SCT_LIBDIR/require.bash"

# Creates a network policy file for the proxy.
# Args:
#   $1 - Path to the policy file
#   $@ - Service names to include (e.g., claude, copilot, vscode, jetbrains, github)
# Outputs:
#   Creates a YAML policy file with services list
policy() {
	local policy_file=$1
	shift
	local services
	services=$(printf '%s\n' "$@")

	require yq

	mkdir -p "$(dirname -- "$policy_file")"
	cp \
		"$SCT_TEMPLATEDIR/policy.yaml" \
		"$policy_file"

	services="$services" yq -i '.services = (strenv(services) | split("\n") )' "$policy_file"

	echo "Policy file created at: $policy_file" | info
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	policy "$@"
fi
