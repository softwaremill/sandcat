#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/logging.bash
source "$SCT_LIBDIR/logging.bash"
# shellcheck source=../../lib/require.bash
source "$SCT_LIBDIR/require.bash"
# shellcheck source=../../lib/select.bash
source "$SCT_LIBDIR/select.bash"
# shellcheck source=../../lib/constants.bash
source "$SCT_LIBDIR/constants.bash"
# shellcheck source=../../lib/path.bash
source "$SCT_LIBDIR/path.bash"

# Initializes sandcat for a project.
# Prompts for any options not provided via flags.
# Args:
#   --agent - Agent type (claude, copilot, codex)
#   --mode - Setup mode (cli, devcontainer)
#   --ide - IDE for devcontainer mode (vscode, jetbrains, none)
#   --name - Project name for Docker Compose
#   --path - Project directory path
init() {
	require yq

	local name=""
	local project_path=""
	local agent=""
	local mode=""
	local ide=""

	while [[ $# -gt 0 ]]
	do
		case $1 in
		--name)
			name="$2"
			shift 2
			;;
		--path)
			project_path="$2"
			shift 2
			;;
		--agent)
			agent="$2"
			shift 2
			;;
		--mode)
			mode="$2"
			shift 2
			;;
		--ide)
			ide="$2"
			shift 2
			;;
		*)
			echo "Unknown option: $1" | error
			return 1
			;;
		esac
	done

	if [[ -z "$project_path" ]]
	then
		project_path="."
	fi

	if [[ ! -d "$project_path" ]]
	then
		echo "Directory does not exist: $project_path" | error
		return 1
	fi
	project_path=$(cd "$project_path" && pwd)

	echo "Configuring project at: $project_path" | info

	if [[ -z "$name" ]]
	then
		name=$(read_line "Project name [empty for default]:")
	fi

	local available_agents=(claude copilot codex)
	if [[ -z "$agent" ]]
	then
		agent=$(select_option "Select agent:" "${available_agents[@]}")
	elif [[ ! " ${available_agents[*]} " =~ [[:space:]]${agent}[[:space:]] ]]
	then
		echo "Invalid agent: $agent (expected: ${available_agents[*]})" | error
		return 1
	fi

	local available_modes=(cli devcontainer)
	if [[ -z "$mode" ]]
	then
		mode=$(select_option "Select mode:" "${available_modes[@]}")
	elif [[ ! " ${available_modes[*]} " =~ [[:space:]]${mode}[[:space:]] ]]
	then
		echo "Invalid mode: $mode (expected: ${available_modes[*]})" | error
		return 1
	fi

	if [[ -z "$name" ]]
	then
		name="$(derive_project_name "$project_path" "$mode")"
	fi

	local policy_file="$SCT_PROJECT_DIR/policy-$mode-$agent.yaml"

	case "$mode" in
	cli)
		policy "$project_path/$policy_file" "$agent"
		cli \
			--policy-file "$policy_file" \
			--project-path "$project_path" \
			--agent "$agent" \
			--name "$name"
		;;
	devcontainer)
		local available_ides=(vscode jetbrains none)
		if [[ -z "$ide" ]]
		then
			ide=$(select_option "Select IDE:" "${available_ides[@]}")
		elif [[ ! " ${available_ides[*]} " =~ [[:space:]]${ide}[[:space:]] ]]
		then
			echo "Invalid IDE: $ide (expected: ${available_ides[*]})" | error
			return 1
		fi

		local services=("$agent")
		if [[ "$ide" != "none" ]]
		then
			services+=("$ide")
		fi

		policy "$project_path/$policy_file" "${services[@]}"
		devcontainer \
			--policy-file "$policy_file" \
			--project-path "$project_path" \
			--agent "$agent" \
			--ide "$ide" \
			--name "$name"
		;;
	*)
		echo "Invalid mode selected: $mode" | error
		return 1
		;;
	esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	init "$@"
fi
