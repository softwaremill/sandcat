#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/logging.bash
source "$AGB_LIBDIR/logging.bash"
# shellcheck source=../../lib/constants.bash
source "$AGB_LIBDIR/constants.bash"
# shellcheck source=../../lib/composefile.bash
source "$AGB_LIBDIR/composefile.bash"

# Sets up CLI mode docker-compose configuration for an agent.
# Copies the docker-compose.yml template and customizes it.
# Args:
#   --policy-file - Path to the policy file (relative to project directory)
#   --project-path - Path to the project directory
#   --agent - The agent name (e.g., "claude")
cli() {
	local policy_file=""
	local project_path=""
	local agent=""
	local name=""

	while [[ $# -gt 0 ]]
	do
		case $1 in
		--policy-file)
			policy_file="$2"
			shift 2
			;;
		--project-path)
			project_path="$2"
			shift 2
			;;
		--agent)
			agent="$2"
			shift 2
			;;
		--name)
			name="$2"
			shift 2
			;;
		*)
			echo "Unknown option: $1" | error
			return 1
			;;
		esac
	done

	: "${policy_file?Missing required parameter: --policy-file}"
	: "${project_path?Missing required parameter: --project-path}"
	: "${agent?Missing required parameter: --agent}"

	local compose_dir="$project_path/$AGB_PROJECT_DIR"
	local compose_file="$compose_dir/docker-compose.yml"

	mkdir -p "$compose_dir"
	cp \
		"$AGB_TEMPLATEDIR/$agent/cli/docker-compose.yml" \
		"$compose_dir"

	local rel_policy_file="../$policy_file"

	customize_compose_file "$rel_policy_file" "$compose_file" "$agent" ""

	local project_name
	project_name="${name:-$(derive_project_name "$project_path" "cli")}"
	set_project_name "$compose_file" "$project_name"

	echo "Compose file created at $compose_file" | info
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	cli "$@"
fi
